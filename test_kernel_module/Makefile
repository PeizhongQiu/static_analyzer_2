# ä¾¿æºå¼æµ‹è¯•é¡¹ç›® Makefile - å¢å¼ºè°ƒè¯•ä¿¡æ¯ç‰ˆæœ¬

# ç¼–è¯‘å™¨è®¾ç½®
CC = clang

# å¢å¼ºçš„ç¼–è¯‘æ ‡å¿— - ä¿ç•™æ›´å¤šç±»å‹å’Œè°ƒè¯•ä¿¡æ¯
CFLAGS = -Wall -Wno-unused-variable -O1 \
         -g3 -gdwarf-4 \
         -fno-eliminate-unused-debug-types \
         -fno-discard-value-names \
         -fstandalone-debug \
         -I./include -std=c99 -D__KERNEL__

# æºæ–‡ä»¶
SOURCES = src/kernel_impl.c \
          src/globals.c \
          src/buffer_manager.c \
          src/device_manager.c \
          src/interrupt_handlers.c \
          src/data_processor.c \
          drivers/test_irq_driver.c

# Bitcodeæ–‡ä»¶
BITCODE_FILES = $(SOURCES:.c=.bc)

# é»˜è®¤ç›®æ ‡
all: bitcode

# ç”Ÿæˆæ‰€æœ‰bitcodeæ–‡ä»¶ï¼ˆä¿ç•™æ›´å¤šè°ƒè¯•ä¿¡æ¯ï¼‰
bitcode: $(BITCODE_FILES)
	@echo "âœ… æ‰€æœ‰bitcodeæ–‡ä»¶ç”Ÿæˆå®Œæˆï¼ˆå¢å¼ºè°ƒè¯•ä¿¡æ¯ï¼‰"
	@echo "ç”Ÿæˆçš„æ–‡ä»¶:"
	@find . -name "*.bc" -exec ls -lh {} \;

# ç”Ÿæˆå•ä¸ªbitcodeæ–‡ä»¶
%.bc: %.c
	@echo "ç¼–è¯‘: $< -> $@ (ä¿ç•™è°ƒè¯•ä¿¡æ¯)"
	@$(CC) $(CFLAGS) -emit-llvm -c $< -o $@

# ç”Ÿæˆcompile_commands.jsonï¼ˆå¢å¼ºè°ƒè¯•ä¿¡æ¯ç‰ˆæœ¬ï¼‰
compile_commands.json:
	@echo "ç”Ÿæˆcompile_commands.jsonï¼ˆå¢å¼ºè°ƒè¯•ä¿¡æ¯ç‰ˆæœ¬ï¼‰..."
	@echo '[' > compile_commands.json
	@i=0; for src in $(SOURCES); do \
		i=$$((i+1)); \
		echo '  {' >> compile_commands.json; \
		echo '    "directory": "$(shell pwd)",' >> compile_commands.json; \
		echo '    "command": "$(CC) $(CFLAGS) -emit-llvm -c $$src",' >> compile_commands.json; \
		echo '    "file": "$$src"' >> compile_commands.json; \
		if [ $$i -lt $(words $(SOURCES)) ]; then \
			echo '  },' >> compile_commands.json; \
		else \
			echo '  }' >> compile_commands.json; \
		fi; \
	done
	@echo ']' >> compile_commands.json
	@echo "âœ… compile_commands.jsonç”Ÿæˆå®Œæˆï¼ˆåŒ…å«å¢å¼ºè°ƒè¯•ä¿¡æ¯ï¼‰"

# æ¸…ç†
clean:
	find . -name "*.bc" -delete
	find . -name "*.ll" -delete
#	rm -f compile_commands.json

# éªŒè¯è°ƒè¯•ä¿¡æ¯
verify-debug: bitcode
	@echo "ğŸ” éªŒè¯è°ƒè¯•ä¿¡æ¯è´¨é‡..."
	@for bc in $(BITCODE_FILES); do \
		echo "æ£€æŸ¥ $$bc:"; \
		llvm-dis $$bc -o - | grep -c "!DI" || echo "  è°ƒè¯•ä¿¡æ¯è¾ƒå°‘"; \
	done

# ç”Ÿæˆäººç±»å¯è¯»çš„LLVM IR
ir: bitcode
	@echo "ğŸ” ç”ŸæˆLLVM IRæ–‡ä»¶ç”¨äºæ£€æŸ¥..."
	@for bc in $(BITCODE_FILES); do \
		ll_file=$${bc%.bc}.ll; \
		echo "$$bc -> $$ll_file"; \
		llvm-dis $$bc -o $$ll_file; \
	done
	@echo "âœ… LLVM IRæ–‡ä»¶ç”Ÿæˆå®Œæˆï¼Œå¯ä»¥æ£€æŸ¥ç»“æ„ä½“å®šä¹‰"

# æ£€æŸ¥ç»“æ„ä½“å®šä¹‰
check-structs: ir
	@echo "ğŸ—ï¸ æ£€æŸ¥ç»“æ„ä½“å®šä¹‰..."
	@echo "buffer_info ç»“æ„ä½“:"
	@grep -A 10 -B 2 "buffer_info.*=" src/*.ll 2>/dev/null | head -15 || echo "  æœªæ‰¾åˆ°buffer_infoå®šä¹‰"
	@echo ""
	@echo "test_device ç»“æ„ä½“:"
	@grep -A 15 -B 2 "test_device.*=" src/*.ll 2>/dev/null | head -20 || echo "  æœªæ‰¾åˆ°test_deviceå®šä¹‰"

# æµ‹è¯•ç¼–è¯‘
test:
	@echo "æµ‹è¯•ç¼–è¯‘ï¼ˆå¢å¼ºè°ƒè¯•ä¿¡æ¯ï¼‰..."
	$(CC) $(CFLAGS) -emit-llvm -c src/globals.c -o src/globals.bc
	@echo "âœ… æµ‹è¯•æˆåŠŸ"
	@ls -lh src/globals.bc
	@echo "æ£€æŸ¥è°ƒè¯•ä¿¡æ¯:"
	@llvm-dis src/globals.bc -o - | grep -c "!DI" && echo "  åŒ…å«è°ƒè¯•ä¿¡æ¯" || echo "  è°ƒè¯•ä¿¡æ¯ä¸è¶³"

.PHONY: all bitcode clean verify-debug ir check-structs test
